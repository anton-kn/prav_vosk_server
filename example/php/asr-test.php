<?php

require_once("./vendor/autoload.php");

use WebSocket\Client;

/**
 * Получаем распознанный текст и косинусное расстояние
 */

$xVectors = [
    [-0.802376, 1.176126, 0.068638, -1.142237, -1.298326, -1.048877, 0.092282, -1.037319, 1.827471, -0.623254, 0.266004, -0.171518, 0.755113, -0.959342, 0.367044, -0.44446, -1.00068, 0.588, 1.194603, -0.021927, -0.184462, 2.293694, 1.766743, 0.648001, 0.419686, 0.200181, -0.154496, -0.11187, 0.39692, 0.732358, -1.394547, -1.703394, -1.779114, 0.464531, 1.29701, -0.466423, -0.190428, 0.846829, -0.513663, 0.615781, 0.301517, 1.830822, 0.937382, -1.395378, 0.28311, -0.50477, 1.348485, -0.026817, 1.500461, 0.691675, 0.154057, -0.545141, -0.882467, 0.505512, 0.427246, -0.349478, -0.08164, 0.174593, 1.858535, -0.101609, 2.902394, -0.644379, 0.54139, -1.045671, -0.885888, -0.761796, -0.835416, 0.552707, -1.924448, 1.353785, -0.555727, -2.258725, -0.154083, 1.592852, -0.095759, 1.003063, -0.315265, 0.762921, 1.509057, 0.773859, -0.061793, -1.584515, -1.667715, -0.116335, -0.122097, -0.584765, -1.585344, -0.07758, -0.468226, -0.43535, -0.929148, -0.197145, -0.679546, -2.021695, 0.773309, 1.169348, 1.06774, -0.346402, 0.638888, 0.955095, 0.300754, -0.556435, -1.18196, -0.661979, 1.422239, -1.178174, -0.790396, 0.927346, -1.756523, 0.230433, -1.446746, 1.091161, 0.586842, -0.512004, 0.916895, 0.136998, -1.729466, 0.950865, 0.467346, 0.330532, -0.482523, 1.049212, 0.459185, -0.528687, -2.018685, 0.582752, -0.009462, -0.01358],
    [-1.081764, 0.924833, 1.955306, -1.207088, -1.046153, -0.5456, 0.360719, -0.967817, 2.523833, 0.009305, 0.806667, -0.12424, 0.265862, -1.262857, 0.565516, 0.659425, -0.768185, 0.303353, 1.427608, -0.719325, -1.125032, 1.068382, 2.76036, 0.057221, -0.454956, 1.199306, 0.113151, -0.326174, 0.94022, 0.710482, -1.441668, -1.431878, -1.143595, -0.4932, 1.074098, 0.650733, 1.173748, 0.39587, -0.367136, 1.820414, -0.008315, 0.957296, 1.370317, -1.083918, -0.182044, -0.148528, -0.023712, -0.674109, 0.322632, 1.286618, 0.389712, 0.215384, -1.222764, 2.536061, -0.204257, -0.512851, 0.186458, 0.302874, 0.918182, -0.414477, 1.739, 0.381467, 0.758822, -1.449643, 0.100735, -0.336153, -1.182301, 1.075487, -1.376806, 0.292261, 0.468004, -1.310002, 1.115095, 1.254397, -0.220198, 0.535032, -0.821799, 1.759314, 0.083812, 0.002252, -0.566117, -2.449116, -1.763279, -0.059235, -0.49574, 1.199501, -0.403231, 0.625242, -0.222384, 0.371212, -0.517047, 0.111044, -1.301764, -0.53572, -0.303378, -0.203388, 0.42784, 0.424179, 0.364228, 2.013411, 0.989398, -0.180654, -0.69211, -0.439733, -0.039068, -2.074178, -0.142072, 1.115302, -1.643872, 0.833141, -2.242847, 0.23285, -0.842745, -0.248269, -0.23115, 0.791567, -0.089238, -0.041573, -0.218408, 1.206125, -0.800296, 0.548713, -0.302409, 0.879828, -1.714942, 1.124456, -1.19388, -0.054715]
];

$client = new Client("ws://localhost:2700", array('timeout' => 2000));

$config = [
    "config" => [
        "x-vectors" => $xVectors
    ]
];

$client->send(json_encode($config));
$myfile = fopen("sample_3.wav", "r");
$res = [];
while (!feof($myfile)) {
    $data = fread($myfile, 8000);
    $client->send($data, 'binary');
    $out = $client->receive();
    echo $out . "\n";
    if ($isOut = json_decode($out, true)) {
        $res[] = $isOut;
    }
}
$client->send("{\"eof\" : 1}");
$out = $client->receive();
if ($isOut = json_decode($out, true)) {
    $res[] = $isOut;
}
echo $out . "\n";

fclose($myfile);

var_dump($res);

function jsonDecode($data)
{
    $values = json_decode($data, true);
    if ($values) {
        return $values;
    }
}
